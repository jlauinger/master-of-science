%% -----------------------------------------------------------------------------

\chapter{In-depth, small-scale study of unsafe code usages}\label{ch:survey-small-scale}

This chapter provides an in-depth study of unsafe usages in 10 selected open-source Go projects.
I analyzed 1000 usages in application code, and 400 usages in the standard library.
The usages are classified in two dimensions by what is happening and what is the higher-level purpose.


%% -----------------------------------------------------------------------------

\section{Methodology}\label{sec:survey-small-methodology}

I analyzed the following projects.
They are a subset of Table~\ref{tbl:projects}.

\begin{table}[h]
    \centering
    \caption{Selected projects for in-depth, small-scale study}
    \label{tbl:survey-small-projects}
    \begin{tabular}{llrrll}
        \toprule
        {}  &                                               Name &  Stars &  Forks & Last Pushed &   Revision \\
        \midrule
        1   &                              kubernetes/kubernetes &  66512 &  23806 & 2020-05-28 &  fb9e1946b0 \\
        2   &                       mattermost/mattermost-server &  18277 &   4157 & 2020-05-28 &  e83cc7357c \\
        3   &                                    rancher/rancher &  14344 &   1758 & 2020-05-28 &  56a464049e \\
        4   &                                   weaveworks/scope &   4354 &    554 & 2020-05-26 &  bf90d56f0c \\
        5   &                                          rook/rook &   7208 &   1472 & 2020-05-28 &  ff90fa7098 \\
        6   &                                      elastic/beats &   8852 &   3207 & 2020-05-28 &  df6f2169c5 \\
        7   &                                hashicorp/terraform &  22151 &   5729 & 2020-05-28 &  01f91316da \\
        8   &                                      cilium/cilium &   5501 &    626 & 2020-05-28 &  9b0ae85b5f \\
        9   &                                       grafana/loki &   9537 &    922 & 2020-05-28 &  10a1f28a85 \\
        10  &                                  gorgonia/gorgonia &   3373 &    301 & 2020-05-24 &  5fb5944d4a \\
        \bottomrule
    \end{tabular}
\end{table}

I selected them based on their high number of unsafe usages, and taking care of that they represent a reasonably large
diversity.
The projects contain applications based around containers and operations, chat, infrastructure as a service, data
storage, visualization, and machine learning.

When selecting samples to look at, I deliberately separated the standard library from application usages.
This is based on the results of the large-scale study shown in Chapter~\ref{ch:survey}, which show that all projects
must use the standard library, and the hypothesis that the standard library uses unsafe patterns differently.
It has to do so because the standard library takes care of low-level memory management by design.

Standard library is defined by the packages that live in the Go standard library and the \texttt{golang.org/x/sys}
module.
I took the decision to include the sys package because it contains a lot of syscall infrastructure and in general
behaves more like the standard library than application code.
It is also maintained by the core Go developer team.
Obviously, application packages is defined as packages that are not part of the standard library.

I randomly sampled 1000 snippets from application packages and 400 snippets from the standard library.
The samples are taken without duplicates in version, that is the same snippet by module, file, and line number is not
taken twice if there is a different version of the same module also available.
This is done by best effort: if the line number changes between module versions there might still be logical
duplication.
The set of deduplication is module, package, file, line number.
I only took samples that contain \texttt{unsafe.Pointer}, no other unsafe matches.

Both because there is no easy way to find out if an imported dependency is maintained by a project itself, or by a
third party, and because it gives a better picture on real unsafe usages in the industry, the unsafe samples are taken
from all dependencies.
Therefore, the snippets are not all part of packages from the ten projects, but some more packages.
They are shown in Table~\ref{tbl:survey-small-packages-app} and Table~\ref{tbl:survey-small-packages-std}.


%% -----------------------------------------------------------------------------

\section{Classification results}\label{sec:survey-small-classification}



%% -----------------------------------------------------------------------------

\section{Classes and examples}\label{sec:survey-small-classes}

