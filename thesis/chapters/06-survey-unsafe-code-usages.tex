%% -----------------------------------------------------------------------------

\chapter{Survey of unsafe code usages in popular Go projects}\label{ch:survey}

A major contribution of this thesis is an analysis of unsafe code usage in the wild:
the top 500 most popular open source Go projects.


%% -----------------------------------------------------------------------------

\section{Most popular open source Go projects}\label{sec:most-popular-projects}

I downloaded the top 500 most popular (by number of stars) Go projects from Github.
They can be found through Github search.

Using the \texttt{github.com/google/go-github/github}~\cite{NEEDED} and \texttt{github.com/go-git/go-git/v5}~\cite{NEEDED}
Go libraries, I found, saved, downloaded, and checkout out these projects using a Go program.

The projects, including the revision I checked out, and some meta data is shown in Table~\ref{tbl:projects}.


%% -----------------------------------------------------------------------------

\section{Methods of generating data points}\label{sec:survey-acquisition-methods}

Iteration of three data acquisition programs, getting faster and faster: Bash, Python, Go.

Loading packages used by the program by running \texttt{go list -deps -json ./...}, then parsing the JSON output.

CSV is used to write data to disk.
Interop with Go structure types is achieved using the \texttt{github.com/gocarina/gocsv}~\cite{NEEDED} library.

Program uses the following steps:

\begin{enumerate}
    \item Read projects to analyze from CSV file
    \item Get package list for a given project
    \item Run requested analysis type
    \item Parse output and match findings to package and file
    \item Append findings for this project to CSV file
    \item Continue with step 2 for the next project, until done
\end{enumerate}

There are five different analysis types:

\begin{itemize}
    \item Grep
    \item Go Vet
    \item Gosec
    \item Abstract Syntax Tree
    \item My linter (go-safer)
\end{itemize}

The time needed to run these analysis on the 500 projects described in Section~\ref{sec:most-popular-projects} is shown
in Table~\ref{tbl:survey-analysis-wallclocktime}.

\begin{table}[h]
    \centering
    \caption{Wall-clock runtime for different analysis types used for the data survey}
    \label{tbl:survey-analysis-wallclocktime}
    \begin{tabular}{ll}
        \toprule
        Analysis Type & Wall-Clock Time \\
        \midrule
        (Project Download) & 4 hours \\
        Grep & 15 minutes \\
        Go Vet & 3 hours \\
        Gosec & 24 hours \\
        Abstract Syntax Tree & 1 hour \\
        Go-Safer Linter & 3.5 hours \\
        \bottomrule
    \end{tabular}
\end{table}


%% -----------------------------------------------------------------------------

\section{Description and structure of data set}\label{sec:survey-dataset}

In the data set I obtained, there are the following objects: projects, packages, modules,  Grep findings, Go Vet findings,
Gosec findings, Go-safer (linter) findings, AST unsafe findings, AST functions, AST statements, and error conditions.

The data set size in terms of object count is shown in Table~\ref{tbl:survey-dataset-size}

\begin{table}[h]
    \centering
    \caption{Survey data set size in terms of object count}
    \label{tbl:survey-dataset-size}
    \begin{tabular}{lr}
        \toprule
        Object type & Data point count \\
        \midrule
        Projects & 495 \\
        Packages & 40,384 \\
        Modules & 3,202 \\
        Grep findings & 2,850,140 \\
        Go Vet findings & 120,416 \\
        Gosec findings & 124,165 \\
        Go-safer (linter) findings & 321 \\
        AST unsafe findings & 2,590,346 \\
        AST functions & 782,760 \\
        AST statements & 1,205,214 \\
        \bottomrule
    \end{tabular}
\end{table}

A thing worth mentioning is that there a bit less AST unsafe findings compared to the Grep unsafe findings. This is
because the Grep run includes comments containing \texttt{unsafe.Pointer}, while the AST run does not.


%% -----------------------------------------------------------------------------

\section{Methods of analyzing the data}\label{sec:survey-analysis-methods}

How did I process the data set?
Approach to build results etc.


%% -----------------------------------------------------------------------------

\subsection{Jupyter Notebooks}\label{subsec:survey-jupyter}

Describe purpose, deployment and notebook structure.


%% -----------------------------------------------------------------------------

\subsection{Python Flask application for manual classification}\label{subsec:survey-classification}

Describe purpose, development and deployment.


%% -----------------------------------------------------------------------------

\section{Survey Results}\label{sec:survey-results}

These sections go through the results of the data survey.
Unsafe usages include usages of \texttt{unsafe.Pointer}, \texttt{uintptr}, \texttt{reflect.SliceHeader} and more.


%% -----------------------------------------------------------------------------

\subsection{Usage statistics in projects, modules, packages, and registries}\label{subsec:results-stats}

First is some statistics about how many unsafe usages were found using Grep.
Unsafe usages are occurrences of the following tokens:

\begin{itemize}
    \item \texttt{unsafe.Pointer}
    \item \texttt{unsafe.Sizeof}
    \item \texttt{unsafe.Alignof}
    \item \texttt{unsafe.Offsetof}
    \item \texttt{uintptr}
    \item \texttt{reflect.SliceHeader}
    \item \texttt{reflect.StringHeader}
\end{itemize}

Figure~\ref{fig:unsafe-usages-by-project-n30} shows the top 30 projects with the most unsafe usages.
We see that \texttt{kubernetes/kubernetes} and \texttt{rancher/k3s} lead the list with more than 10,000 usages.

\begin{figure}[ht]
    \centering
    {\scriptsize \includegraphics[width=\textwidth, height=9cm]{assets/plots/stats/unsafe-usages-by-project-n30.tikz}}
    \caption{Unsafe usages by project for the top 30 projects with most usages}
    \label{fig:unsafe-usages-by-project-n30}
\end{figure}

Looking at individual modules, we see from Figure~\ref{fig:unsafe-usages-by-module-n30} that most usages are contained
in the Go standard library.
Second place with still a lot of unsafe usages is the \texttt{k8s/kubernetes} module, followed by
\texttt{golang.org/x/sys}.
The \texttt{sys} module already has some space to the \texttt{kubernetes} one, and after that the modules have much
fewer unsafe usages.

\begin{figure}[ht]
    \centering
    {\scriptsize \includegraphics[width=\textwidth, height=9cm]{assets/plots/stats/unsafe-usages-by-module-n30.tikz}}
    \caption{Unsafe usages by module for the top 30 modules with most usages}
    \label{fig:unsafe-usages-by-module-n30}
\end{figure}

Figure~\ref{fig:unsafe-usages-by-package-n30} shows the top 30 packages with the most unsafe usages.
Keeping in mind that we just learned that the standard library has the most usages, we can now see that they are mostly
in the \texttt{runtime}, \texttt{syscall}, and \texttt{reflect} packages.
We can identify some more packages from this figure which are analyzed in more detail in Chapter~\ref{ch:code-vulnerabilities}.

\begin{figure}[ht]
    \centering
    {\scriptsize \includegraphics[width=\textwidth, height=9cm]{assets/plots/stats/unsafe-usages-by-package-n30.tikz}}
    \caption{Unsafe usages by package for the top 30 packages with most usages}
    \label{fig:unsafe-usages-by-package-n30}
\end{figure}

Looking at Figure~\ref{fig:unsafe-usages-by-registry}, we see that if we skip the standard library and the Kubernetes
situation, almost all unsafe usages are contained in packages that are hosted on github.com.
However, the data also shows (without plot) that github.com is by far the largest registry, therefore this is expected.
The other big registry is gorgonia.org, which hosts a machine learning framework that will be part of the discussion in
Chapter~\ref{ch:code-vulnerabilities}.

\begin{figure}[ht]
    \centering
    {\scriptsize \includegraphics[width=\textwidth, height=7cm]{assets/plots/stats/unsafe-usages-by-registry.tikz}}
    \caption{Unsafe usages by registry}
    \label{fig:unsafe-usages-by-registry}
\end{figure}

Finally, we see from Figure~\ref{fig:fraction-of-unsafe-modules-and-packages} that only about 20 percent of modules, and
less than 5 percent of packages contain unsafe usages.
We conclude that they are clustered in a small group of packages.
In other words, if a package contains \textit{any} unsafe usage then it will probably contain \textit{many}.

\begin{figure}[ht]
    \centering
    \subfigure[Modules]{
        {\scriptsize \includegraphics[width=0.4\textwidth]{assets/plots/stats/pie-modules.tikz}}
        \label{subfig:fraction-of-unsafe-modules}
    }
    \subfigure[Packages]{
        {\scriptsize \includegraphics[width=0.4\textwidth]{assets/plots/stats/pie-packages.tikz}}
        \label{subfig:fraction-of-unsafe-packages}
    }
    \caption{Fraction of modules and packages containing unsafe usages}
    \label{fig:fraction-of-unsafe-modules-and-packages}
\end{figure}


%% -----------------------------------------------------------------------------

\subsection{Distribution of different unsafe token types}\label{subsec:results-tokens-distribution}

\begin{figure}[ht]
    \centering
    {\scriptsize \includegraphics[width=0.5\textwidth, height=9cm]{assets/plots/tokens-distribution/distribution-different-unsafe-token-types.tikz}}
    \caption{Distribution of different types of unsafe token types}
    \label{fig:unsafe-tokens-distribution}
\end{figure}


%% -----------------------------------------------------------------------------

\subsection{Module and package popularity}\label{subsec:results-popularity}

\begin{figure}[ht]
    \centering
    {\scriptsize \includegraphics[width=\textwidth, height=9cm]{assets/plots/popularity/popularity-module-n30.tikz}}
    \caption{Module popularity by number of importing projects, N=30}
    \label{fig:popularity-module}
\end{figure}

\begin{figure}[ht]
    \centering
    {\scriptsize \includegraphics[width=\textwidth, height=9cm]{assets/plots/popularity/popularity-package-without-std-n30.tikz}}
    \caption{Package popularity by number of importing projects, excluding standard library, N=30}
    \label{fig:popularity-package}
\end{figure}


%% -----------------------------------------------------------------------------

\subsection{Fluctuation of unsafe usages count over time}\label{subsec:results-time-change}

\begin{figure}[ht]
    \centering
    {\scriptsize \includegraphics[width=\textwidth, height=10cm]{assets/plots/time-change/fluctuation-in-versions-of-sys.tikz}}
    \caption{Number of unsafe usages in different versions (every other) of sys over time}
    \label{fig:fluctuation-in-versions-of-sys}
\end{figure}

Figure~\ref{fig:fluctuation-in-versions-of-sys} shows the number of \texttt{unsafe.Pointer} usages in different versions
of the \texttt{golang.org/x/sys} package.
We can see that the number changes over time.
In this case, it ranges between 315 and 440.
This is because different versions of the same package can contain different code, and therefore a different number of
\texttt{unsafe.Pointer} usages.
Here the reason for this is that syscall stubs get added or removed.

For \texttt{sys}, the number of unsafe usages gradually increases over time.
Todo: include an example commit compare.

We can take away two important insights from this.

\begin{enumerate}
    \item It is important to pin the version of the module / package when doing analysis on the code, e.g.\ running a
    survey on the usage of unsafe code patterns.
    \item Even when a vulnerability is fixed in the latest version of a library, projects that use that library will
    still be affected until they upgrade the library.
    Different projects can use different versions of the same library.
\end{enumerate}

%% -----------------------------------------------------------------------------

\subsection{Correlations of unsafe tokens used together in a file or statement}\label{subsec:results-correlation-together}

Number of unsafe.Pointer files: 1061
Number of uintptr files: 1147

Number of files with both usages: 496

Number of unsafe.Pointer lines: 12135
Number of uintptr lines: 11951

Number of usages of unsafe.Pointer in files where at least one other uintptr occurs: 6846
Number of usages of uinttr in files where at least one other unsafe.Pointer occurs: 5939

In der gleichen Funktion: 11,738
Alleinstehend: 8,841
Insgesamt: 20,579

Im gleichen Statement: 7,246 (verteilt auf 2,123 Statements)
Falls ein Statement unsafe enthält, enthält es im Schnitt 3.4 solcher Nutzungen.
Alleinstehend: 13,757
Insgesamt: 21,003

Hinweis zur Interpretation: Es gibt also 8,466 unsafe.Pointer oder uintptr Nutzungen (zusammen).
Oben bei der Auswertung von Vorkommnissen in der gleichen Datei steht:

Number of lines containing unsafe.Pointer in files where at least one other uintptr occurs: 6889

Nun könnte man sich denken: wie können 8466 Vorkommnisse im gleichen Statement sein, wenn nur 6889 überhaupt in der
gleichen Datei auch nur ein anderes Vorkommen haben?

Die Antwort darauf ist: Viele Zeilen enthalten mehrere unsafe.Pointer oder mehrere uintptr Vorkommnisse.
Diese werden bei der Dateianalyse dedupliziert, weil nach dem Subset Package/File/LineNumber Duplikate entfernt werden.
Das ist nötig, weil ansonsten der Merge mit dem Datensatz selbst dafür sorgt, dass insgesamt mehr Usages zu existieren
scheinen als es überhaupt gibt, denn jede Usage in der Zeile würde mit allen Usages in ebendieser Zeile gematcht werden.

Der Datensatz, den Grep erzeugt hat, erlaubt an dieser Stelle leider einfach keine genauere Auswertung.

\begin{figure}[ht]
    \centering
    {\scriptsize \includegraphics[width=\textwidth, height=3cm]{assets/plots/correlation-together/use-in-same-line.tikz}}
    \caption{Usage of unsafe together in the same line}
    \label{fig:correlations-unsafe-usage-same-line}
\end{figure}

\begin{figure}[ht]
    \centering
    \subfigure[Functions]{
        {\scriptsize \includegraphics[width=0.4\textwidth]{assets/plots/correlation-together/use-in-same-function.tikz}}
        \label{subfig:correlations-unsafe-usage-same-function}
    }
    \subfigure[Statements]{
        {\scriptsize \includegraphics[width=0.4\textwidth]{assets/plots/correlation-together/use-in-same-statement.tikz}}
        \label{subfig:correlations-unsafe-usage-same-statement}
    }
    \caption{Usage of unsafe in the same function or statement}
    \label{fig:correlations-unsafe-usage-same-function-and-statement}
\end{figure}


%% -----------------------------------------------------------------------------

\subsection{Go Vet and Gosec tools coverage of unsafe snippets}\label{subsec:results-vet-gosec}

\begin{figure}[ht]
    \centering
    {\scriptsize \includegraphics[width=\textwidth, height=9cm]{assets/plots/vet-gosec/vet-findings-per-project-n30.tikz}}
    \caption{Go Vet findings per projects for the top 30 projects with the most findings}
    \label{fig:vet-findings-per-project-n30}
\end{figure}

\begin{figure}[ht]
    \centering
    {\scriptsize \includegraphics[width=\textwidth, height=4cm]{assets/plots/vet-gosec/vet-findings-correlated-unsafe-findings.tikz}}
    \caption{Correlation of Go Vet and Grep unsafe findings}
    \label{fig:correlation-vet-grep-findings}
\end{figure}

\begin{table}
    \centering
    \caption{Vet possible misuse of unsafe.Pointer findings per package}
    \label{tbl:vet-misuse-findings}

    \subtable[Raw findings before deduplication]{
        \label{subtbl:vet-findings-duplicates}
        \begin{tabular}{lr}
            \toprule
            Package                                 & Number of findings          \\
            \midrule
            runtime                                 &                      60164 \\
            sync/atomic                             &                        338 \\
            strings                                 &                        335 \\
            github.com/modern-go/reflect2           &                         46 \\
            golang.org/x/sys/unix                   &                         16 \\
            github.com/spaolacci/murmur3            &                         11 \\
            gorgonia.org/tensor                     &                          8 \\
            github.com/apache/arrow/go/arrow/math   &                          6 \\
            github.com/minio/simdjson-go            &                          4 \\
            github.com/apache/arrow/go/arrow/memory &                          4 \\
            github.com/AndreasBriese/bbloom         &                          4 \\
            github.com/coocood/bbloom               &                          2 \\
            github.com/segmentio/encoding/json      &                          1 \\
            \bottomrule
        \end{tabular}
    }

    \subtable[After deduplication]{
        \label{subtbl:vet-findings-deduplicated}
        \begin{tabular}{lr}
            \toprule
            Package                                 & Number of findings          \\
            \midrule
            runtime                                 &                         175 \\
            gorgonia.org/tensor                     &                           8 \\
            github.com/apache/arrow/go/arrow/math   &                           6 \\
            github.com/minio/simdjson-go            &                           3 \\
            github.com/apache/arrow/go/arrow/memory &                           3 \\
            github.com/spaolacci/murmur3            &                           2 \\
            github.com/coocood/bbloom               &                           2 \\
            github.com/AndreasBriese/bbloom         &                           2 \\
            sync/atomic                             &                           1 \\
            strings                                 &                           1 \\
            golang.org/x/sys/unix                   &                           1 \\
            github.com/segmentio/encoding/json      &                           1 \\
            github.com/modern-go/reflect2           &                           1 \\
            \bottomrule
        \end{tabular}
    }
\end{table}


%% -----------------------------------------------------------------------------

\subsection{Correlation of unsafe usages with project features}\label{subsec:results-correlation-project}

\begin{figure}[ht]
    \centering
    {\scriptsize \includegraphics[width=\textwidth, height=9cm]{assets/plots/correlation-project/correlation-imports-grep-vet.tikz}}
    \caption{Correlation of number of imports, Grep unsafe, and Vet findings of projects}
    \label{fig:correlations-project-imports-grep-vet}
\end{figure}

\begin{figure}[ht]
    \centering
    {\scriptsize \includegraphics[width=\textwidth, height=9cm]{assets/plots/correlation-project/correlation-unsafe-stars.tikz}}
    \caption{Correlation of number of unsafe usages and number of stars of projects}
    \label{fig:correlations-project-unsafe-stars}
\end{figure}

\begin{figure}[ht]
    \centering
    {\scriptsize \includegraphics[width=\textwidth, height=9cm]{assets/plots/correlation-project/correlation-unsafe-age.tikz}}
    \caption{Correlation of number of unsafe usages and age of projects}
    \label{fig:correlations-project-unsafe-age}
\end{figure}

\begin{figure}[ht]
    \centering
    {\scriptsize \includegraphics[width=\textwidth, height=9cm]{assets/plots/correlation-project/correlation-unsafe-module-popularity.tikz}}
    \caption{Correlation of number of unsafe usages and popularity of modules}
    \label{fig:correlations-module-unsafe-popularity}
\end{figure}


%% -----------------------------------------------------------------------------

\subsection{Most interesting modules for analysis}\label{subsec:results-most-interesting-modules}

To determine which modules are the most interesting ones for analysis in Chapter~\ref{ch:code-vulnerabilities}, I use
a score.
It is the product of unsafe usage count in a module and the import count of that module, a good indication of its
popularity. Table~\ref{tbl:most-interesting-modules-by-score} shows the top 20 most interesting modules.

\begin{table}
    \centering
    \caption{Most interesting modules for analysis by score, N=20}
    \label{tbl:most-interesting-modules-by-score}
    \begin{tabular}{llrrr}
        \toprule
        {} &                           Module & Unsafe usages count & Import count &    Score \\
        \midrule
        1  &                              std &                6676 &          495 &  3304620 \\
        2  &                 golang.org/x/sys &                1163 &          235 &   273305 \\
        3  &                 golang.org/x/net &                  91 &          217 &    19747 \\
        4  &      github.com/json-iterator/go &                 225 &           71 &    15975 \\
        5  &    github.com/modern-go/reflect2 &                 215 &           71 &    15265 \\
        6  &                k8s.io/kubernetes &                1887 &            8 &    15096 \\
        7  &       github.com/golang/protobuf &                  65 &          168 &    10920 \\
        8  &         github.com/gogo/protobuf &                 103 &          105 &    10815 \\
        9  &  github.com/hashicorp/go-msgpack &                 792 &           12 &     9504 \\
        10 &       github.com/ugorji/go/codec &                 823 &           11 &     9053 \\
        11 &               golang.org/x/tools &                 178 &           42 &     7476 \\
        12 &              golang.org/x/crypto &                  28 &          191 &     5348 \\
        13 &             github.com/ugorji/go &                 804 &            6 &     4824 \\
        14 &       github.com/davecgh/go-spew &                  38 &          106 &     4028 \\
        15 &                 go.etcd.io/bbolt &                 148 &           24 &     3552 \\
        16 &   k8s.io/apiextensions-apiserver &                 124 &           26 &     3224 \\
        17 &               gonum.org/v1/gonum &                 416 &            5 &     2080 \\
        18 &         github.com/docker/docker &                  42 &           47 &     1974 \\
        19 &   github.com/vishvananda/netlink &                 158 &           12 &     1896 \\
        20 &                gvisor.dev/gvisor &                1846 &            1 &     1846 \\
        \bottomrule
    \end{tabular}
\end{table}


%% -----------------------------------------------------------------------------

\subsection{Number of reflect.SliceHeader and reflect.StringHeader usages}\label{subsec:results-sliceheader}

SliceHeader and StringHeader count: 341 and XX before deduplication.

These get analyzed in depth in Chapter~\ref{ch:code-vulnerabilities}.


%% -----------------------------------------------------------------------------

\section{Publication of data set}\label{sec:survey-publication}

To obtain the data set, do this:

Clone it from Github?
