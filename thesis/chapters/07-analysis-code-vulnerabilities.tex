%% -----------------------------------------------------------------------------

\chapter{Analysis of code vulnerabilities due to unsafe code}\label{ch:code-vulnerabilities}

This chapter provides an in-depth security analysis of unsafe code usages, both of patterns found in the data set
described in Chapter~\ref{ch:survey} as well as theoretical reasoning.


%% -----------------------------------------------------------------------------

\section{Code flow redirection}\label{sec:vulnerability-flow-redirection}

Notes: Go uses no \acrshort{aslr}, binaries are statically linked and the standard library is huge.
Therefore binaries provide a lot of ROP gadgets and spawning a shell from a buffer overflow is easier than with a
comparable C program.


%% -----------------------------------------------------------------------------

\section{Garbage collector race}\label{sec:vulnerability-gc-race}


%% -----------------------------------------------------------------------------

\section{Broken escape analysis}\label{sec:vulnerability-escape-analysis}


%% -----------------------------------------------------------------------------

\section{Cast in one statement}\label{sec:cast-1-statement}

Is the identified unsafe cast pattern safe if it is done in one statement?

\begin{lstlisting}[language=Golang, label=lst:cast-1-statement, caption=Unsafe slice cast in one single statement]
strHeader := (*reflect.StringHeader)(unsafe.Pointer(&s))
return *(*[]byte)(unsafe.Pointer(&reflect.SliceHeader{
    Data: strHeader.Data,
    Cap:  strHeader.Len,
    Len:  strHeader.Len,
}))
\end{lstlisting}

The garbage collector race exploit does not work anymore with this.
This might be because of the time delay, because the assembly looks IDENTICAL!

Escape analysis however can still not see the connection, the escape analysis exploit still works.


%% -----------------------------------------------------------------------------

\section{Misaligned memory layout}\label{sec:vulnerability-alignment}


%% -----------------------------------------------------------------------------

\section{Submission of fixes to open-source libraries}\label{sec:vulnerability-fixes}

The following Github pull requests were submitted to notify the projects.

\begin{table}[h]
    \centering
    \caption{Github pull requests to fix vulnerable Go libraries}
    \label{tbl:pull-requests}
    \begin{tabularx}{\textwidth}{rlXll}
        \toprule
        {} & Project & PR-Name & Popularity & Link \\
        \midrule
        1  & hanwen/go-fuse & batch forget: fix missing return to handle malformed input data & 3 projects & \href{https://www.github.com/hanwen/go-fuse/pull/363}{PR \#363} \\
        2  & buger/jsonparser & Fix possible memory confusion in unsafe slice cast & 4 projects & \href{https://www.github.com/buger/jsonparser/pull/204}{PR \#204} \\
        3  & elastic/go-structform & Fix possible memory confusion\ldots & 1 project & \href{https://github.com/elastic/go-structform/pull/21}{PR \#21} \\
        4  & go-fiber/utils & Fix possible memory confusion\ldots & 1 project & \href{https://github.com/gofiber/utils/pull/7}{PR \#7} \\
        5  & influxdata/influxdb & fix: possible memory confusion\ldots & 8 projects & \href{https://github.com/influxdata/influxdb/pull/18307}{PR \#18307} \\
        6  & influxdata/influxdb1-client & fix: possible memory confusion\ldots & 4 projects & \href{https://github.com/influxdata/influxdb1-client/pull/40}{PR \#40} \\
        7  & modern-go/reflect2 & Fix possible memory confusion\ldots & 71 projects & \href{https://github.com/modern-go/reflect2/pull/13}{PR \#13} \\
        8  & savsgio/gotils & Fix possible memory confusion\ldots & 1 project & \href{https://github.com/savsgio/gotils/pull/2}{PR \#2} \\
        9  & valyala/fasttemplate & Fix possible memory confusion\ldots & 10 projects & \href{https://github.com/valyala/fasttemplate/pull/21}{PR \#21} \\
        10 & weaveworks/ps & Fix possible memory confusion\ldots & 1 project & \href{https://github.com/weaveworks/ps/pull/3}{PR \#3} \\
        11 & yuin/goldmark & Fix possible memory confusion\ldots & 5 projects & \href{https://github.com/yuin/goldmark/pull/134}{PR \#134} \\
        12 & yuin/gopher-lua & Fix possible memory confusion\ldots & 6 projects & \href{https://github.com/yuin/gopher-lua/pull/287}{PR \#287} \\
        13 & gorgonia/tensor & Fix possible memory confusion\ldots & 1 project & \href{https://github.com/gorgonia/tensor/pull/68}{PR \#68} \\
        \bottomrule
    \end{tabularx}
\end{table}

The following pull requests did exist already:

\begin{table}[h]
    \centering
    \caption{Github pull requests already existing}
    \label{tbl:pull-requests-existing}
    \begin{tabularx}{\textwidth}{rlXll}
        \toprule
        {} & Project & PR-Name & Popularity & Link \\
        \midrule
        1  & mailru/easyjson & fix unsafe `unsafe` usage & 42 projects & \href{https://github.com/mailru/easyjson/pull/258}{PR \#258} \\
        \bottomrule
    \end{tabularx}
\end{table}
